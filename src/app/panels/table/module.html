<div ng-controller='table' ng-init='init()'>
  <style>
    .table-doc-table {
      margin-left: 0px !important;
      overflow-y: auto;
      overflow-x: scroll;
    }
    .nolink {
      color:black;
      text-decoration: none;
    }
    .nolink:focus {
      color:#1ab2ff;
      text-decoration: none;
    }
    .nolink:hover {
      color:#1ab2ff;
      text-decoration: none;
    }
  </style>
  <div class="row-fluid">
    <div ng-class="{'span3':panel.field_list}" ng-show="panel.field_list">
      <div class="sidebar-nav">
        <h5>Fields <a href="" alt="Hide Field List" class=" icon-chevron-sign-left pointer " ng-click="panel.field_list = !panel.field_list" bs-tooltip="'Hide field list'" ng-show="panel.field_list"></a></h5>
        <ul class="unstyled" style="{{panel.overflow}}:{{panel.height || row.height}};overflow-y:auto;overflow-x:hidden;">
          <li ng-style="panel.style" ng-repeat="field in fields.list" ng-show="_.isUndefined(panel.important_fields) || _.contains(panel.important_fields,field)">
            <a href="" title="Include Field" alt="Include Field" class="pointer" ng-class="{'icon-check': _.contains(panel.fields,field),'icon-check-empty': !_.contains(panel.fields,field)}" ng-click="toggle_field(field)"></a>
            <a href="" title="Field Stats" alt="Field Stats" class="pointer" data-unique="1" bs-popover="'app/panels/table/micropanel.html'" data-placement="right" ng-click="toggle_micropanel(field,true)" ng-class="{label: _.contains(panel.fields,field)}">{{facet_label(field)}}</a>
          </li>
        </ul>
      </div>
    </div>

    <div style="{{panel.overflow}}:{{panel.height || row.height}};" ng-class="{'span9':panel.field_list,'span12':!panel.field_list}" class="table-doc-table">
      <a class="nolink pull-left icon-chevron-sign-right pointer" ng-click="panel.field_list = !panel.field_list" alt='Show field list' href="" bs-tooltip="'Show field list'" ng-show="!panel.field_list"></a>

      <div class="row-fluid" ng-show="panel.paging">
        <div class="span1 offset1" style="text-align:right">
          <a href="" title="Previous Page" alt="Previous Page" ng-click="panel.offset = 0" ng-show="panel.offset > 0" class='nolink icon-circle-arrow-left pointer'></a>
          <a href="" title="Previous Page" alt="Previous Page" ng-click="panel.offset = (panel.offset - panel.size)" ng-show="panel.offset > 0" class='nolink icon-arrow-left pointer'></a>
        </div>
        <div class="span8" style="text-align:center">
          <strong ng-show="hits > 0" ng-hide="hits == 0">{{panel.offset + 1}}</strong><strong ng-show="hits == 0" ng-hide="hits > 0">{{panel.offset}}</strong> to <strong>{{dashboard.numberWithCommas(panel.offset + data.slice(panel.offset,panel.offset+panel.size).length)}}</strong>
          <small> of {{dashboard.numberWithCommas(data.length)}} available for paging</small>
        </div>
        <div class="span1" style="text-align:left">
          <a href="" title="Next Page" alt="Next Page" ng-click="panel.offset = (panel.offset + panel.size)" ng-show="data.length > panel.offset+panel.size" class='nolink icon-arrow-right pointer'></a>
        </div>
      </div>

      <table class="table-hover table table-condensed" ng-style="panel.style">
        <thead ng-show="panel.header">
          <th ng-show="panel.fields.length<1">message (select columns from the list to the left)</th>
          <th></th>
          <th style="white-space:nowrap" ng-repeat="field in panel.fields">
            <a href="" alt="Move column left" bs-tooltip="'Move column left'" ng-show="!$first" class="nolink pointer link icon-caret-left" ng-click="_.move(panel.fields,$index,$index-1)"></a>
            <span  >
              <a href="" alt="Sort on Column" bs-tooltip="'Sort on Column'" class="nolink pointer" ng-click="set_sort(field)" ng-show='panel.sortable'>{{facet_label(field)}} </a>
              <a href="" alt="Sort Order {{ panel.sort[1] }}" ng-show='field == panel.sort[0]'
                class=" nolink pointer link" ng-class="{'icon-chevron-up': panel.sort[1] == 'asc','icon-chevron-down': panel.sort[1] == 'desc'}"></a>
            </span>
            <span ng-show='!panel.sortable'>{{facet_label(field)}}</span>
            <a href="" alt="Move column right" bs-tooltip="'Move column right'" ng-show="!$last" class="nolink pointer link icon-caret-right" ng-click="_.move(panel.fields,$index,$index+1)"></a>
          </th>
          <!-- Hyperlink column header -->
          <th ng-show="panel.enableHyperlink" style="white-space:nowrap">{{panel.hyperlinkColumnHeader}}</th>
        </thead>

        <tbody ng-repeat="event in data | slice:panel.offset:panel.offset+panel.size" ng-class-odd="'odd'">

          <tr ng-keypress="toggle_details(event)" ng-keydown="toggle_details(event)" ng-click="toggle_details(event)" class="pointer">
            <td>
              <a href="" alt="Expand Table Item" title="Expand Table Item" tabindex="0" ng-keypress="toggle_details(event)" ng-keydown="toggle_details(event)"></a>
            </td>
            <td ng-show="panel.fields.length<1">

              {{event.kibana._source|stringify|tableTruncate:panel.trimFactor:1}}
            </td>

            <!-- Table columns -->
            <td ng-show="panel.fields.length>0" ng-repeat="field in panel.fields"
              ng-bind-html-unsafe="(event.kibana.highlight[field]||event.kibana._source[field]) |tableHighlight |tableTruncate:panel.trimFactor:panel.fields.length:field:panel.imageFields |tableDisplayImageField:field:panel.imageFields:panel.imgFieldWidth:panel.imgFieldHeight"></td>

            <!-- Hyperlink column -->
            <td ng-click="" ng-show="panel.enableHyperlink && panel.displayLinkIcon" ng-bind-html-unsafe="event.kibana._source[panel.hyperlinkColumnForURI] |urlLinkAsIcon"></td>
            <td ng-show="panel.enableHyperlink && !panel.displayLinkIcon" ng-bind-html-unsafe="event.kibana._source[panel.hyperlinkColumnForURI] |urlLink"></td>
            <!-- end Hyperlink column -->
          </tr>
          <tr ng-show="event.kibana.details">
            <td colspan={{panel.fields.length}} ng-switch="event.kibana.view">
              <span>
                View:
                <a href="" title="JSON" alt="JSON" class="link" ng-class="{'strong':event.kibana.view == 'table'}" ng-click="event.kibana.view = 'table'">Table</a> /
                <a href="" title="JSON" alt="JSON" class="link" ng-class="{'strong':event.kibana.view == 'json'}" ng-click="event.kibana.view = 'json'">JSON</a> /
                <a href="" title="JSON" alt="JSON" class="link" ng-class="{'strong':event.kibana.view == 'raw'}" ng-click="event.kibana.view = 'raw'">Raw</a>
                <a href="" title="JSON" alt="JSON" class="link pull-right icon-chevron-up" ng-click="toggle_details(event)"></a>
              </span>
              <table class='table table-bordered table-condensed' ng-switch-when="table">
                <thead>
                  <th>Field</th>
                  <th>Action</th>
                  <th>Value</th>
                </thead>
                <tr ng-repeat="(key,value) in event.kibana._source" ng-class-odd="'odd'">
                  <td>{{key}}</td>
                  <td style="white-space:nowrap">
                    <a href="" alt="Filter on items where {{key}} field is {{value}}" class='nolink icon-search pointer' ng-click="build_search(key,value)" bs-tooltip="'Add filter to match this value'"></a>
                    <a href="" alt="Filter on items where {{key}} field is not {{value}}" class='nolink icon-ban-circle pointer' ng-click="build_search(key,value,true)" bs-tooltip="'Add filter to NOT match this value'"></a>
                    <a href="" alt="Add {{key}} field as a column" class="nolink pointer icon-th" ng-click="toggle_field(key)" bs-tooltip="'Toggle table column'"></a>
                  </td>
                  <!-- At some point we need to create a more efficient way of applying the filter pipeline -->
                  <td style="white-space:pre-wrap" ng-bind-html-unsafe="value|noXml|urlLink|stringify"></td>
                </tr>
              </table>
              <pre style="white-space:pre-wrap"  ng-bind-html="without_kibana(event)|tableJson:2" ng-switch-when="json"></pre>
              <pre ng-bind-html="without_kibana(event)|tableJson:1" ng-switch-when="raw"></pre>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="row-fluid" ng-show="panel.paging">
        <div class="span1 offset3" style="text-align:right">
          <i ng-click="panel.offset = 0" ng-show="panel.offset > 0" class='icon-circle-arrow-left pointer'></i>
          <i ng-click="panel.offset = (panel.offset - panel.size)" ng-show="panel.offset > 0" class='icon-arrow-left pointer'></i>
        </div>
        <div class="span4" style="text-align:center">
          <strong ng-show="hits > 0" ng-hide="hits == 0">{{panel.offset + 1}}</strong><strong ng-show="hits == 0" ng-hide="hits > 0">{{panel.offset}}</strong> to <strong>{{dashboard.numberWithCommas(panel.offset + data.slice(panel.offset,panel.offset+panel.size).length)}}</strong>
          <small> of {{dashboard.numberWithCommas(data.length)}} available for paging</small>
        </div>
        <div class="span1" style="text-align:left">
          <i ng-click="panel.offset = (panel.offset + panel.size)" ng-show="data.length > panel.offset+panel.size" class='icon-arrow-right pointer'></i>
        </div>
      </div>
    </div>
  </div>
</div>
